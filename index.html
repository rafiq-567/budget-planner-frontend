<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Planner Pro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>

<body class="bg-[#f0f2f5] p-6 md:p-12 font-sans">

  <div class="max-w-[450px] mx-auto bg-white p-6 rounded-2xl shadow-2xl border border-gray-100">
    <h2 class="text-center text-indigo-600 text-3xl font-extrabold mb-6 tracking-tight">Budget Planner</h2>

    <div class="space-y-3">
        <input id="name" class="w-full p-3 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all" placeholder="Expense Name" />
        <input id="amount" type="number" class="w-full p-3 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all" placeholder="Amount ($)" />
        <input id="interest" class="w-full p-3 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all" placeholder="Notes/Interest" />

        <button id="saveBtn" class="flex items-center justify-center gap-2 w-full p-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 active:scale-95 transition-all shadow-lg shadow-indigo-200 disabled:bg-indigo-300">
            <span id="btnText">Save Budget</span>
            <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </div>

    <div class="mt-8 p-4 bg-slate-800 rounded-xl text-white flex justify-between items-center shadow-inner">
        <span class="text-sm font-medium text-slate-400 uppercase tracking-widest">Total Spent</span>
        <span id="totalDisplay" class="text-2xl font-black text-emerald-400">$0</span>
    </div>

    <div id="list" class="mt-6 space-y-4"></div>
  </div>

<script>
  const API = "https://budget-planner-api.budget-planner-api.workers.dev";

  const nameInput = document.getElementById("name");
  const amountInput = document.getElementById("amount");
  const interestInput = document.getElementById("interest");
  const list = document.getElementById("list");
  const saveBtn = document.getElementById("saveBtn");
  const btnText = document.getElementById("btnText");
  const spinner = document.getElementById("spinner");
  const totalDisplay = document.getElementById("totalDisplay");

  let currentTotal = 0;

  // --- ANIMATIONS ---

  function animateTotal(newTotal) {
    const obj = { val: currentTotal };
    anime({
      targets: obj,
      val: newTotal,
      round: 1,
      duration: 600,
      easing: 'easeOutExpo',
      update: () => {
        totalDisplay.innerHTML = `$${obj.val}`;
      }
    });
    currentTotal = newTotal;
  }

  function animateListIn() {
    anime({
      targets: '.item',
      opacity: [0, 1],
      translateX: [-20, 0],
      delay: anime.stagger(100),
      easing: 'easeOutElastic(1, .8)'
    });
  }

  async function animateDelete(el) {
    await anime({
      targets: el,
      opacity: 0,
      translateX: 50,
      duration: 300,
      easing: 'easeInQuint'
    }).finished;

    await anime({
      targets: el,
      height: 0,
      marginTop: 0,
      marginBottom: 0,
      padding: 0,
      duration: 300,
      easing: 'easeInOutQuad'
    }).finished;
    
    el.remove();
  }

  // --- CORE LOGIC ---

  function createItemHTML(budget, pending = false) {
    return `
      <div class="item ${pending ? "opacity-50" : ""} group p-4 bg-indigo-50 border border-indigo-100 rounded-xl hover:shadow-md transition-all" data-id="${budget.id}">
        <div class="flex justify-between items-center">
            <div class="flex flex-col">
                <strong class="text-slate-800 text-lg leading-tight">${budget.name}</strong> 
                <small class="text-slate-500 italic mt-1 text-xs">${budget.interest || 'No notes'}</small>
            </div>
            <div class="text-right">
                <span class="block text-xl font-black text-indigo-600">$${budget.amount}</span>
                <button class="text-xs text-red-400 hover:text-red-600 font-bold uppercase tracking-tighter mt-1 cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteBudget('${budget.id}', ${budget.amount})">
                  Remove
                </button>
            </div>
        </div>
      </div>
    `;
  }

  function setButtonLoading(isLoading) {
    saveBtn.disabled = isLoading;
    if (isLoading) {
        btnText.innerText = "Saving...";
        spinner.classList.remove('hidden');
    } else {
        btnText.innerText = "Save Budget";
        spinner.classList.add('hidden');
    }
  }

  async function saveBudget() {
    if (!nameInput.value || !amountInput.value) return;

    setButtonLoading(true);

    const payload = {
      name: nameInput.value,
      amount: Number(amountInput.value),
      interest: interestInput.value
    };

    try {
      const res = await fetch(API + "/budget", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error();
      
      // Success: Reload everything to get the real database ID
      await loadBudgets();
      
      // Clear inputs
      [nameInput, amountInput, interestInput].forEach(i => i.value = "");
    } catch {
      alert("Error saving budget");
    } finally {
      setButtonLoading(false);
    }
  }

  async function loadBudgets() {
    const res = await fetch(API + "/budget?ts=" + Date.now());
    const data = await res.json();

    let total = 0;
    list.innerHTML = "";
    
    data.forEach(budget => {
      total += Number(budget.amount);
      list.insertAdjacentHTML("beforeend", createItemHTML(budget));
    });
    
    animateTotal(total);
    animateListIn();
  }

  async function deleteBudget(id, amount) {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (!el) return;

    // Update total immediately for better feel
    animateTotal(currentTotal - amount);
    await animateDelete(el);
    
    await fetch(API + "/budget/" + id, { method: "DELETE" });
  }

  saveBtn.addEventListener("click", saveBudget);
  loadBudgets();
</script>

</body>
</html>